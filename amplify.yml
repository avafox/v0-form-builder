version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 20
        - nvm use 20
        - node --version
        - npm install --legacy-peer-deps
        - |
          cat > lib/runtime-config.ts << 'EOF'
          // Auto-generated at build time by Amplify
          export const runtimeConfig = {
            NEXTAUTH_SECRET: process.env.NEXTAUTH_SECRET || "${NEXTAUTH_SECRET}",
            NEXTAUTH_URL: process.env.NEXTAUTH_URL || "${NEXTAUTH_URL}",
            MICROSOFT_CLIENT_ID: process.env.MICROSOFT_CLIENT_ID || "${MICROSOFT_CLIENT_ID}",
            MICROSOFT_CLIENT_SECRET: process.env.MICROSOFT_CLIENT_SECRET || "${MICROSOFT_CLIENT_SECRET}",
            MICROSOFT_TENANT_ID: process.env.MICROSOFT_TENANT_ID || "${MICROSOFT_TENANT_ID}",
          };
          EOF
        - sed -i "s|\${NEXTAUTH_SECRET}|$NEXTAUTH_SECRET|g" lib/runtime-config.ts
        - sed -i "s|\${NEXTAUTH_URL}|$NEXTAUTH_URL|g" lib/runtime-config.ts
        - sed -i "s|\${MICROSOFT_CLIENT_ID}|$MICROSOFT_CLIENT_ID|g" lib/runtime-config.ts
        - sed -i "s|\${MICROSOFT_CLIENT_SECRET}|$MICROSOFT_CLIENT_SECRET|g" lib/runtime-config.ts
        - sed -i "s|\${MICROSOFT_TENANT_ID}|$MICROSOFT_TENANT_ID|g" lib/runtime-config.ts
        - echo "Generated runtime config:"
        - cat lib/runtime-config.ts
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
